---
import { getEntry, render } from "astro:content";
import { ROUTES } from "mona-kiosk";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import Header from "../../components/Header.astro";
import { SITE_TITLE } from "../../consts";

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect("/courses");
}

const slugParts = slug.split("/");
const isCourseDetail = slugParts.length === 1;
const courseId = isCourseDetail
  ? slugParts[0]
  : slugParts.slice(0, -1).join("/");
const chapterSlug = isCourseDetail ? null : slugParts[slugParts.length - 1];

const course = await getEntry("courses", `${courseId}/toc`);

if (!course) {
  return Astro.redirect("/courses");
}

const flattenStructure = (structure: Array<Record<string, unknown>>) => {
  const chapters: Array<{ slug: string; title: string; free?: boolean }> = [];
  for (const item of structure) {
    if ("chapters" in item && Array.isArray(item.chapters)) {
      for (const chapter of item.chapters) {
        if (chapter && typeof chapter === "object") {
          const typed = chapter as { slug: string; title: string; free?: boolean };
          chapters.push({
            slug: typed.slug,
            title: typed.title,
            free: typed.free,
          });
        }
      }
    } else if ("slug" in item && typeof item.slug === "string") {
      const typed = item as { slug: string; title: string; free?: boolean };
      chapters.push({
        slug: typed.slug,
        title: typed.title,
        free: typed.free,
      });
    }
  }
  return chapters;
};

const structure = course.data.structure as Array<any>;
const chapters = flattenStructure(structure);
const chapterMeta = chapterSlug
  ? chapters.find((chapter) => chapter.slug === chapterSlug)
  : null;
const chapterIsFree = chapterMeta?.free ?? false;

const hasAccess = course.data.price
  ? Astro.locals.paywall?.hasAccess === true
  : true;
const canAccessChapter = hasAccess || chapterIsFree;

const checkoutContentId = `courses/${courseId}/toc`;
const checkoutUrl = `${ROUTES.CHECKOUT}?content=${encodeURIComponent(
  checkoutContentId,
)}`;
const formattedPrice = course.data.price
  ? `$${(course.data.price / 100).toFixed(2)}`
  : "Free";

let chapter = null;
let ChapterContent = null;

if (!isCourseDetail && chapterSlug) {
  chapter = await getEntry("courseChapters", `${courseId}/${chapterSlug}`);
  if (!chapter) {
    return Astro.redirect(`/courses/${courseId}`);
  }
  const rendered = await render(chapter);
  ChapterContent = rendered.Content;
}

const pageTitle = isCourseDetail
  ? `${course.data.title} | ${SITE_TITLE}`
  : `${chapter?.data.title} - ${course.data.title} | ${SITE_TITLE}`;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={pageTitle} description={course.data.description} />
		<style>
			main {
				width: 960px;
			}
			.course-hero {
				margin-bottom: 2rem;
			}
			.course-hero h1 {
				font-size: 2.25rem;
				margin: 0 0 0.5rem 0;
				color: rgb(var(--black));
			}
			.course-hero p {
				margin: 0.5rem 0;
				color: rgb(var(--gray-dark));
			}
			.toc {
				list-style: none;
				padding: 0;
				margin: 1.5rem 0;
				border: 1px solid rgba(var(--gray), 0.2);
				border-radius: 12px;
			}
			.toc li {
				padding: 0.75rem 1rem;
				border-top: 1px solid rgba(var(--gray), 0.2);
			}
			.toc li:first-child {
				border-top: none;
			}
			.toc a {
				text-decoration: none;
				color: rgb(var(--black));
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			.toc .part {
				background: rgba(var(--gray), 0.08);
				font-weight: 600;
			}
			.locked {
				color: rgb(var(--gray));
				font-size: 0.85rem;
			}
			.chapter-content {
				margin-top: 2rem;
			}
			.paywall {
				margin-top: 2rem;
				padding: 2rem;
				border: 1px solid rgba(var(--gray), 0.2);
				border-radius: 12px;
				background: white;
			}
			.paywall a {
				display: inline-block;
				margin-top: 1rem;
				color: white;
				background: var(--accent);
				padding: 0.6rem 1rem;
				border-radius: 6px;
				text-decoration: none;
				font-weight: 600;
			}
			@media (max-width: 720px) {
				main {
					width: 100%;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<a href="/courses">‚Üê All courses</a>

			{isCourseDetail ? (
				<section class="course-hero">
					<h1>{course.data.title}</h1>
					<p>{course.data.description}</p>
					<p>
						<strong>{formattedPrice}</strong>
					</p>
					{course.body && (
						<div>
							{async () => {
								const { Content } = await render(course);
								return <Content />;
							}}
						</div>
					)}
					<ul class="toc">
						{structure.map((item) => {
							const typedItem = item as any;
							if ("chapters" in typedItem && Array.isArray(typedItem.chapters)) {
								return (
									<li class="part">
										{typedItem.title}
										<ul class="toc">
											{typedItem.chapters.map((chapter: any) => {
												const isFree = !!chapter.free;
												return (
													<li>
														<a href={`/courses/${courseId}/${chapter.slug}`}>
															<span>{chapter.title}</span>
															{!isFree && course.data.price && (
																<span class="locked">Locked</span>
															)}
														</a>
													</li>
												);
											})}
										</ul>
									</li>
								);
							}
							return (
								<li>
									<a href={`/courses/${courseId}/${typedItem.slug}`}>
										<span>{typedItem.title}</span>
										{!typedItem.free && course.data.price && (
											<span class="locked">Locked</span>
										)}
									</a>
								</li>
							);
						})}
					</ul>
				</section>
			) : (
				<section class="chapter-content">
					<h1>{chapter?.data.title}</h1>
					{canAccessChapter ? (
						<article>
							{ChapterContent && <ChapterContent />}
						</article>
					) : Astro.locals.paywall?.preview ? (
						<div set:html={Astro.locals.paywall.preview} />
					) : (
						<div class="paywall">
							<h2>This chapter is locked</h2>
							<p>Purchase the full course to unlock all chapters.</p>
							<p>
								<strong>{formattedPrice}</strong>
							</p>
							<a href={checkoutUrl}>Purchase course</a>
						</div>
					)}
				</section>
			)}
		</main>
		<Footer />
	</body>
</html>
